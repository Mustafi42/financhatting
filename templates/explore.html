{% extends "base.html" %}
{% block title %}Ke≈üfet ‚Ä¢ Financhatting{% endblock %}

{% block content %}
<div class="page">
  <div class="page-head">
    <div>
      <h1 class="page-title">üß≠ Ke≈üfet</h1>
      <p class="page-subtitle">Trend semboller ‚Ä¢ En √ßok etkile≈üim alan payla≈üƒ±mlar ‚Ä¢ Arama</p>
    </div>
    <div class="page-actions">
      <input id="q" class="search" placeholder="Kullanƒ±cƒ± (@mehmet) veya sembol (BTC) ara..." />
      <button class="btn btn-ghost" id="btnSearch">Ara</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-head">
        <h2>üî• Trend Semboller</h2>
        <span class="muted">y√ºksek deƒüi≈üim / √ßok yorum</span>
      </div>
      <div id="trendSymbols" class="list">
        <div class="loading"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h2>‚≠ê En Etkile≈üimli ƒ∞√ßerikler</h2>
        <span class="muted">puan + yorum</span>
      </div>
      <div id="trendPosts" class="list">
        <div class="loading"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>
      </div>
    </div>
  </div>

  <div id="exploreError" class="error-message" style="display:none;"></div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .page{max-width:1100px;margin:0 auto;padding:10px 6px 40px;}
  .page-head{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin:8px 0 18px;flex-wrap:wrap;}
  .page-title{font-size:2.2em;color:var(--green);margin:0 0 6px;text-shadow:0 0 20px rgba(16,185,129,.25);}
  .page-subtitle{margin:0;color:var(--muted);}
  .page-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  .search{
    min-width: 280px;
    border:1px solid var(--border);
    background: rgba(15,23,42,.35);
    color: var(--text);
    border-radius: 999px;
    padding: 11px 14px;
    outline:none;
  }
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  .card{
    background: linear-gradient(145deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--border);
    border-radius:16px;
    padding:16px;
    overflow:hidden;
  }
  .card-head{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px;}
  .card-head h2{margin:0;color:var(--text);font-size:1.2em;}
  .muted{color:var(--muted2);font-size:.92em;}
  .list{display:flex;flex-direction:column;gap:10px;}
  .item{
    border:1px solid rgba(51,65,85,.8);
    background: rgba(15,23,42,.25);
    border-radius:14px;
    padding:12px 12px;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .left{min-width:0;}
  .title{font-weight:900;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .sub{color:var(--muted2);font-size:.92em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
  .badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:3px 10px;border-radius:999px;border:1px solid var(--border);
    background: rgba(15,23,42,.35);color:var(--muted);font-size:.85em;font-weight:800;
  }
  .badge.green{border-color:rgba(16,185,129,.55);color:var(--green);}
  .badge.blue{border-color:rgba(59,130,246,.55);color:var(--blue);}
  .badge.red{border-color:rgba(239,68,68,.55);color:#ef4444;}
  a.link{color:var(--muted);text-decoration:none;font-weight:800;}
  a.link:hover{color:var(--text);text-decoration:underline;}
  .loading{text-align:center;padding:24px 0;color:var(--muted2);}
  .spinner{border:3px solid var(--border);border-top:3px solid var(--green);border-radius:50%;width:34px;height:34px;animation:spin 1s linear infinite;margin:0 auto 12px;}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .error-message{background:rgba(239,68,68,.1);border:1px solid #ef4444;color:#fca5a5;padding:15px;border-radius:10px;text-align:center;margin:10px 0;}
  @media (max-width: 900px){.grid{grid-template-columns:1fr}.search{min-width: 220px}}
</style>
{% endblock %}

{% block extra_js %}
<script>
  const $ = (q)=>document.querySelector(q);

  function esc(s){return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}
  async function apiGet(url){
    const r = await fetch(url,{credentials:"include"});
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }
  function setError(msg){
    const e=$("#exploreError"); e.textContent=msg; e.style.display="block";
  }

  function symbolBadge(changePct){
    if(changePct == null) return "";
    const pct = Number(changePct);
    const cls = pct>=0 ? "green":"red";
    return `<span class="badge ${cls}">%${pct.toFixed(2)}</span>`;
  }

  function renderSymbolRow(s){
    // expected: { key:"BTC", name:"Bitcoin", change_pct: 3.2, comments: 12 }
    return `
      <div class="item">
        <div class="left">
          <div class="title">#${esc(s.key)}</div>
          <div class="sub">${esc(s.name||"")}</div>
        </div>
        <div class="right">
          ${symbolBadge(s.change_pct)}
          <span class="badge blue">üí¨ ${Number(s.comments||0)}</span>
          <a class="link" href="/s/${encodeURIComponent(s.key)}">A√ß</a>
        </div>
      </div>
    `;
  }

  function renderPostRow(p){
    // expected: { id, user:{username, full_name}, content, rating:{avg,count}, symbol_key }
    const who = p.user?.full_name || p.user?.username || "Kullanƒ±cƒ±";
    const handle = p.user?.username ? "@"+p.user.username : "@user";
    const sym = p.symbol_key ? `<span class="badge blue">#${esc(p.symbol_key)}</span>` : "";
    const avg = Number(p.rating?.avg||0).toFixed(1);
    const cnt = Number(p.rating?.count||0);
    const snippet = (p.content||"").slice(0,120);
    return `
      <div class="item">
        <div class="left">
          <div class="title">${esc(who)} <span class="muted">(${esc(handle)})</span></div>
          <div class="sub">${esc(snippet)}${(p.content||"").length>120?"‚Ä¶":""}</div>
        </div>
        <div class="right">
          ${sym}
          <span class="badge green">‚òÖ ${avg}</span>
          <span class="badge blue">Oy ${cnt}</span>
          <a class="link" href="/@${encodeURIComponent(p.user?.username||"")}">Profil</a>
        </div>
      </div>
    `;
  }

  async function loadExplore(q=""){
    try{
      $("#exploreError").style.display="none";
      const data = await apiGet(`/api/explore?q=${encodeURIComponent(q)}`);
      const sym = $("#trendSymbols");
      const posts = $("#trendPosts");

      sym.innerHTML = "";
      posts.innerHTML = "";

      const symbols = data.symbols || [];
      const topPosts = data.posts || [];

      if(symbols.length===0){
        sym.innerHTML = `<div class="item"><div class="left"><div class="sub">Trend sembol yok.</div></div></div>`;
      } else {
        sym.innerHTML = symbols.map(renderSymbolRow).join("");
      }

      if(topPosts.length===0){
        posts.innerHTML = `<div class="item"><div class="left"><div class="sub">Trend i√ßerik yok.</div></div></div>`;
      } else {
        posts.innerHTML = topPosts.map(renderPostRow).join("");
      }
    }catch(e){
      console.error(e);
      setError("Ke≈üfet y√ºklenemedi. (API hen√ºz eklenmemi≈ü olabilir.)");
    }
  }

  $("#btnSearch").onclick = ()=> loadExplore($("#q").value||"");
  $("#q").addEventListener("keydown",(ev)=>{ if(ev.key==="Enter") loadExplore($("#q").value||""); });

  loadExplore();
</script>
{% endblock %}