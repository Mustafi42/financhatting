{% extends "base.html" %}
{% block title %}Sembol â€¢ Financhatting{% endblock %}

{% block content %}
<div class="page">
  <div class="head">
    <div>
      <h1 class="title">ðŸ“Š #{{ symbol_key }}</h1>
      <p class="sub">Grafik + bu sembole Ã¶zel yorumlar</p>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" id="btnFull">â›¶ Tam Ekran</button>
      <a class="btn btn-ghost" href="/feed">Feed</a>
    </div>
  </div>

  <div class="card chart-card">
    <div id="tv_chart_container" style="height: 520px;"></div>
  </div>

  <div class="card comments" id="comments">
    <div class="comments-head">
      <h2>ðŸ’¬ Yorumlar</h2>
      <button class="btn btn-ghost" id="btnRefresh">â†»</button>
    </div>

    <div class="composer">
      <textarea id="commentText" rows="3" maxlength="400" placeholder="#{{ symbol_key }} hakkÄ±nda yorum yaz..."></textarea>
      <div class="composer-row">
        <span class="small" id="count">0/400</span>
        <button class="btn btn-primary" id="btnSend">GÃ¶nder</button>
      </div>
      <div id="commentMsg" class="msg" style="display:none;"></div>
    </div>

    <div id="commentList" class="list">
      <div class="loading"><div class="spinner"></div><p>YÃ¼kleniyor...</p></div>
    </div>

    <div id="symErr" class="error-message" style="display:none;"></div>
  </div>
</div>

<!-- Fullscreen modal -->
<div id="chartModal">
  <div class="modal-content">
    <button class="close-btn" id="btnClose">Kapat X</button>
    <div id="tv_chart_full" style="height: 100%;"></div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
  .page{max-width:1100px;margin:0 auto;padding:10px 6px 40px;}
  .head{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin:8px 0 18px;flex-wrap:wrap;}
  .title{font-size:2.2em;color:var(--green);margin:0 0 6px;text-shadow:0 0 20px rgba(16,185,129,.25);}
  .sub{margin:0;color:var(--muted);}
  .actions{display:flex;gap:10px;flex-wrap:wrap;}
  .card{
    background: linear-gradient(145deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--border);
    border-radius:16px;
    overflow:hidden;
  }
  .chart-card{padding:8px;margin-bottom:14px;}
  .comments{padding:16px;}
  .comments-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;}
  .comments-head h2{margin:0;color:var(--text);font-size:1.2em;}
  textarea{
    width:100%;
    border:1px solid var(--border);
    background: rgba(15,23,42,.35);
    color:var(--text);
    border-radius:14px;
    padding:12px 14px;
    outline:none;
    resize:vertical;
    font-family:inherit;
  }
  .composer-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:10px;flex-wrap:wrap;}
  .small{color:var(--muted2);font-size:.92em;}
  .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(16,185,129,.55);background:rgba(16,185,129,.08);color:var(--green);font-weight:900;}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:14px;}
  .item{border:1px solid rgba(51,65,85,.85);background: rgba(15,23,42,.25);border-radius:16px;padding:14px;}
  .item .top{display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px;}
  .who{font-weight:1000;color:var(--text);}
  .time{color:var(--muted2);font-size:.9em;}
  .content{color:var(--text);white-space:pre-wrap;line-height:1.55;}
  .error-message{background:rgba(239,68,68,.1);border:1px solid #ef4444;color:#fca5a5;padding:15px;border-radius:10px;text-align:center;margin:10px 0;}
  .loading{text-align:center;padding:18px 0;color:var(--muted2);}
  .spinner{border:3px solid var(--border);border-top:3px solid var(--green);border-radius:50%;width:34px;height:34px;animation:spin 1s linear infinite;margin:0 auto 12px;}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

  /* Full screen modal - mevcut stile sadÄ±k */
  #chartModal{
    display:none; position:fixed; inset:0;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    backdrop-filter: blur(5px);
  }
  .modal-content{
    background: #1e293b;
    width: 100vw; height: 100vh;
    margin: 0;
    border-radius: 0;
    position: relative;
    border: 1px solid #334155;
    overflow: hidden;
  }
  .close-btn{
    position:absolute; top:15px; right:20px;
    background:#ef4444; color:white; border:none;
    padding:10px 20px; border-radius:8px; cursor:pointer;
    z-index:10001; font-weight:900;
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  const SYMBOL = "{{ symbol_key }}";

  const tvMap = {
    "BTC": "BINANCE:BTCUSDT",
    "GOLD": "TVC:GOLD",
    "SILVER": "TVC:SILVER",
    "USDTRY": "FX:USDTRY",
    "EURTRY": "FX:EURTRY",
    "BIST100": "BIST:XU100"
  };

  function tvSymbol(key){ return tvMap[key] || key; }
  async function apiGet(url){const r=await fetch(url,{credentials:"include"}); if(!r.ok) throw new Error(await r.text()); return await r.json();}
  async function apiPost(url,payload){const r=await fetch(url,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload||{})}); if(!r.ok) throw new Error(await r.text()); return await r.json();}
  function esc(s){return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}
  function showMsg(t){const m=document.getElementById("commentMsg"); m.textContent=t; m.style.display="block"; setTimeout(()=>m.style.display="none", 3000);}

  function renderChart(containerId, sym){
    new TradingView.widget({
      "autosize": true,
      "symbol": sym,
      "interval": "60",
      "timezone": "Europe/Istanbul",
      "theme": "dark",
      "style": "1",
      "locale": "tr",
      "enable_publishing": false,
      "hide_side_toolbar": false,
      "allow_symbol_change": true,
      "container_id": containerId,
      "studies": ["Volume@tv-basicstudies"]
    });
  }

  function openFull(){
    document.getElementById("chartModal").style.display="block";
    document.getElementById("tv_chart_full").innerHTML="";
    renderChart("tv_chart_full", tvSymbol(SYMBOL));
  }
  function closeFull(){
    document.getElementById("chartModal").style.display="none";
    document.getElementById("tv_chart_full").innerHTML="";
  }

  function renderComment(c){
    const who = c.user?.full_name || c.user?.username || "KullanÄ±cÄ±";
    const when = new Date(c.created_at).toLocaleString("tr-TR");
    return `
      <div class="item">
        <div class="top">
          <div class="who">${esc(who)} <span style="color:var(--muted)">(@${esc(c.user?.username||"")})</span></div>
          <div class="time">${esc(when)}</div>
        </div>
        <div class="content">${esc(c.content||"")}</div>
      </div>
    `;
  }

  async function loadComments(){
    try{
      document.getElementById("symErr").style.display="none";
      const data = await apiGet(`/api/symbol/${encodeURIComponent(SYMBOL)}/comments`);
      const list = document.getElementById("commentList");
      list.innerHTML = "";
      const items = data.items || [];
      list.innerHTML = items.length ? items.map(renderComment).join("") : `<div class="item"><div class="time">HenÃ¼z yorum yok.</div></div>`;
    }catch(e){
      console.error(e);
      const err=document.getElementById("symErr");
      err.textContent="Yorumlar yÃ¼klenemedi. (API henÃ¼z eklenmemiÅŸ olabilir.)";
      err.style.display="block";
      document.getElementById("commentList").innerHTML="";
    }
  }

  async function sendComment(){
    const t = (document.getElementById("commentText").value||"").trim();
    if(!t) return showMsg("Yorum boÅŸ olamaz.");
    try{
      document.getElementById("btnSend").disabled = true;
      await apiPost(`/api/symbol/${encodeURIComponent(SYMBOL)}/comment`, { content: t });
      document.getElementById("commentText").value="";
      document.getElementById("count").textContent="0/400";
      showMsg("GÃ¶nderildi âœ…");
      await loadComments();
    }catch(e){
      console.error(e);
      showMsg("GÃ¶nderilemedi. GiriÅŸ yapman gerekebilir.");
    }finally{
      document.getElementById("btnSend").disabled = false;
    }
  }

  // init
  renderChart("tv_chart_container", tvSymbol(SYMBOL));
  loadComments();

  document.getElementById("btnFull").onclick = openFull;
  document.getElementById("btnClose").onclick = closeFull;
  document.getElementById("btnRefresh").onclick = loadComments;
  document.getElementById("btnSend").onclick = sendComment;
  document.getElementById("commentText").addEventListener("input",(e)=>{
    document.getElementById("count").textContent = `${(e.target.value||"").length}/400`;
  });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeFull(); });
</script>
{% endblock %}